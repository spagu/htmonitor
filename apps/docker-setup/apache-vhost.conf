<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/html
    
    # Enable rewrite engine
    RewriteEngine On
    
    # GeoIP Mock - Set environment variables based on query parameter or header
    # Usage: ?country=DE or X-Test-Country: DE header
    RewriteCond %{QUERY_STRING} country=([A-Z]{2}) [NC]
    RewriteRule .* - [E=GEOIP_COUNTRY_CODE:%1]
    
    RewriteCond %{HTTP:X-Test-Country} ^([A-Z]{2})$ [NC]
    RewriteRule .* - [E=GEOIP_COUNTRY_CODE:%1]
    
    # Default to empty if no country specified (for testing fallback)
    RewriteCond %{ENV:GEOIP_COUNTRY_CODE} ^$
    RewriteCond %{QUERY_STRING} !country=
    RewriteCond %{HTTP:X-Test-Country} ^$
    RewriteRule .* - [E=GEOIP_COUNTRY_CODE:]
    
    # Debug header to show what country was detected
    Header always set X-Debug-Country "%{GEOIP_COUNTRY_CODE}e"
    Header always set X-Debug-Query "%{QUERY_STRING}e"
    
    # Log format to see redirects
    LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\" \"Country:%{GEOIP_COUNTRY_CODE}e\"" combined_geo
    CustomLog /var/log/apache2/access.log combined_geo
    ErrorLog /var/log/apache2/error.log
    
    # Allow .htaccess overrides
    <Directory /var/www/html>
        AllowOverride All
        Require all granted
    </Directory>
    
</VirtualHost>
